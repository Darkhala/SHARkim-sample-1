<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Products - Sharkim Traders</title>
  <link rel="icon" type="image/png" href="/images/icon logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: "Times New Roman", Times, serif, Arial, Helvetica, sans-serif; }
    /* Fallback utility classes if Tailwind fails to load */
    .hidden { display: none !important; }
    .flex { display: flex !important; }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-7xl mx-auto bg-white p-6 rounded shadow">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold">Manage Products</h2>
      <div class="flex items-center gap-3">
        <span id="userEmail" class="text-sm text-gray-600"></span>
        <button id="logoutBtn" class="bg-gray-800 hover:bg-black text-white px-3 py-2 rounded">Logout</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="mb-4 grid grid-cols-1 md:grid-cols-12 gap-2">
      <div class="md:col-span-6 flex gap-2">
        <input id="searchInput" type="text" placeholder="Search by product title..." class="w-full px-4 py-2 border rounded" />
        <button id="searchBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Search</button>
      </div>
      <div class="md:col-span-3">
        <select id="categorySelect" class="w-full px-3 py-2 border rounded">
          <option value="">All Categories</option>
        </select>
      </div>
      <div class="md:col-span-3">
        <select id="subcategorySelect" class="w-full px-3 py-2 border rounded" disabled>
          <option value="">All Subcategories</option>
        </select>
      </div>
    </div>

    <div class="mb-4">
      <button id="resetBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">Reset</button>
    </div>

    <!-- Products Grid -->
    <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden items-center justify-center z-40">
      <div class="flex items-center gap-3 bg-white px-4 py-3 rounded shadow">
        <svg class="animate-spin h-5 w-5 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <span id="loadingText" class="text-gray-700">Loading...</span>
      </div>
    </div>

    <p id="status" class="mt-4 text-sm text-gray-700"></p>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white w-full max-w-2xl rounded shadow p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">Edit Product</h3>
        <button id="closeEditModal" class="text-gray-500 hover:text-black">x</button>
      </div>

      <form id="editForm" class="space-y-4">
        <!-- Title -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Title</label>
          <input id="editTitle" type="text" class="w-full px-3 py-2 border rounded" required />
        </div>

        <!-- Prices -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700">New Price (Ksh)</label>
            <input id="editPrice" type="number" step="0.01" class="w-full px-3 py-2 border rounded" required />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Original Price (Ksh)</label>
            <input id="editOriginalPrice" type="number" step="0.01" class="w-full px-3 py-2 border rounded" required />
          </div>
        </div>

        <!-- Category (same list as upload) -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Category</label>
          <select id="editCategory" class="w-full px-3 py-2 border rounded" required>
            <option value="">-- Select Category --</option>
            <option>Electronics & Technology</option>
            <option>Computer Accessories</option>
            <option>Audio & Music Equipment</option>
            <option>Cameras & Video Gear</option>
            <option>Security & Surveillance</option>
            <option>Printers & Scanners</option>
            <option>Software & Games</option>
            <option>Laptops & Desktops</option>
            <option>TV & DVD Equipment</option>
            <option>Video Game Consoles & Game</option>
            <option>Mobile Phones & Tablets</option>
            <option>Mobile Phones</option>
            <option>Phone Accessories</option>
            <option>Tablets</option>
            <option>Smart Watches & Trackers</option>
            <option>Fashion & Beauty</option>
            <option>Clothing & Accessories</option>
            <option>Shoes</option>
            <option>Bags</option>
            <option>Jewelry</option>
            <option>Watches</option>
            <option>Wedding Wear & Accessories</option>
            <option>Bath & Body, Makeup, Fragrance</option>
            <option>Hair & Skin Care</option>
            <option>Sexual Wellness</option>
            <option>Babies & Kids: Clothing, Toys, Prams, Children's Gear</option>
            <option>Food, Agriculture & Farming</option>
            <option>Commercial Equipment & Tools</option>
            <option>Repair & Construction</option>
          </select>
        </div>

        <!-- Description (kept as 'subcategory' in DB) -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Description</label>
          <textarea id="editSubcategory" class="w-full px-3 py-2 border rounded h-28" placeholder="Product Description"></textarea>
        </div>

        <!-- Image Replace -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Product Image</label>
          <div class="flex items-center gap-3 mb-2">
            <img id="editImagePreview" src="" alt="Preview" class="h-20 w-20 object-cover rounded border" />
            <span class="text-xs text-gray-500">Leave empty to keep current image</span>
          </div>
          <input id="editImage" type="file" accept="image/*" class="w-full px-3 py-2 border rounded" />
        </div>

        <div class="pt-2 flex justify-end gap-2">
          <button type="button" id="cancelEdit" class="px-4 py-2 border rounded">Cancel</button>
          <button id="saveBtn" type="submit" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded">Save</button>
        </div>
      </form>
      <p id="editStatus" class="mt-2 text-sm"></p>
    </div>
  </div>

  <script>
    // =====================
    // CONFIG & SUPABASE
    // =====================
    const supabaseUrl = 'https://evmiakneqtoxvnzeiwlz.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2bWlha25lcXRveHZuemVpd2x6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMTU4NTEsImV4cCI6MjA2OTg5MTg1MX0.lgW9OGAg8etuIzWPs-t0Ek_P7y3_m5GEo-ZSzbqbsGc';
    const client = window.supabase.createClient(supabaseUrl, supabaseKey);
    const ADMIN_EMAIL = 'sharkimtraders97@gmail.com';

    // =====================
    // AUTH GUARD
    // =====================
    async function ensureAuth() {
      try {
        const { data: { session } } = await client.auth.getSession();
        if (!session) { window.location.href = 'login.html'; return false; }
        const userEmail = session.user?.email || '';
        document.getElementById('userEmail').textContent = userEmail;
        if (userEmail.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
          await client.auth.signOut();
          window.location.href = 'login.html';
          return false;
        }
        client.auth.onAuthStateChange((event) => { if (event === 'SIGNED_OUT') window.location.href = 'login.html'; });
        return true;
      } catch { window.location.href = 'login.html'; return false; }
    }

    // =====================
    // DOM ELEMENTS
    // =====================
    const statusText = document.getElementById('status');
    const productsGrid = document.getElementById('productsGrid');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const resetBtn = document.getElementById('resetBtn');
    const categorySelect = document.getElementById('categorySelect');
    const subcategorySelect = document.getElementById('subcategorySelect');
    const logoutBtn = document.getElementById('logoutBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');

    // Edit modal elements
    const editModal = document.getElementById('editModal');
    const closeEditModalBtn = document.getElementById('closeEditModal');
    const cancelEditBtn = document.getElementById('cancelEdit');
    const editForm = document.getElementById('editForm');
    const editTitle = document.getElementById('editTitle');
    const editPrice = document.getElementById('editPrice');
    const editOriginalPrice = document.getElementById('editOriginalPrice');
    const editCategory = document.getElementById('editCategory');
    const editSubcategory = document.getElementById('editSubcategory');
    const editImage = document.getElementById('editImage');
    const editImagePreview = document.getElementById('editImagePreview');
    const editStatus = document.getElementById('editStatus');
    const saveBtn = document.getElementById('saveBtn');

    // =====================
    // STATE
    // =====================
    let latestProducts = [];
    let editingProductId = null;
    let editingCurrentImageUrl = null;

    function showLoading(text = 'Loading...') {
      if (loadingText) loadingText.textContent = text;
      if (loadingOverlay) { loadingOverlay.classList.remove('hidden'); loadingOverlay.classList.add('flex'); }
    }
    function hideLoading() {
      if (loadingOverlay) { loadingOverlay.classList.add('hidden'); loadingOverlay.classList.remove('flex'); }
    }

    // =====================
    // DATA FETCHING
    // =====================
    async function fetchCategories() {
      // Fill categories from DB unique values, but fall back to static list if none
      const { data, error } = await client.from('Products').select('category').order('category', { ascending: true });
      const staticOptions = [
        'Electronics & Technology','Computer Accessories','Audio & Music Equipment','Cameras & Video Gear','Security & Surveillance','Printers & Scanners','Software & Games','Laptops & Desktops','TV & DVD Equipment','Video Game Consoles & Game','Mobile Phones & Tablets','Mobile Phones','Phone Accessories','Tablets','Smart Watches & Trackers','Fashion & Beauty','Clothing & Accessories','Shoes','Bags','Jewelry','Watches','Wedding Wear & Accessories','Bath & Body, Makeup, Fragrance','Hair & Skin Care','Sexual Wellness','Babies & Kids: Clothing, Toys, Prams, Children’s Gear','Food, Agriculture & Farming','Commercial Equipment & Tools','Repair & Construction'
      ];
      let categories = [];
      if (!error && data) categories = Array.from(new Set(data.map(r => r.category).filter(Boolean)));
      if (categories.length === 0) categories = staticOptions;
      categorySelect.innerHTML = '<option value="">All Categories</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    async function fetchSubcategories(category) {
      if (!category) { subcategorySelect.innerHTML = '<option value="">All Subcategories</option>'; subcategorySelect.disabled = true; return; }
      const { data, error } = await client.from('Products').select('subcategory').eq('category', category).order('subcategory', { ascending: true });
      if (error) { subcategorySelect.innerHTML = '<option value="">All Subcategories</option>'; subcategorySelect.disabled = true; return; }
      const subs = Array.from(new Set((data || []).map(r => r.subcategory).filter(Boolean)));
      subcategorySelect.innerHTML = '<option value="">All Subcategories</option>' + subs.map(s => `<option value="${s}">${s}</option>`).join('');
      subcategorySelect.disabled = false;
    }

    async function fetchProducts(searchTerm = '', category = '', subcategory = '') {
      showLoading('Loading products...');
      statusText.textContent = 'Loading products...';
      let query = client.from('Products').select('*').order('id', { ascending: false });
      if (searchTerm) query = query.ilike('title', `%${searchTerm}%`);
      if (category) query = query.eq('category', category);
      if (subcategory) query = query.eq('subcategory', subcategory);
      const { data, error } = await query;
      if (error) { statusText.textContent = '❌ Error: ' + error.message; hideLoading(); return; }
      latestProducts = data || [];
      renderProducts(latestProducts);
      statusText.textContent = `✅ Loaded ${latestProducts.length} product${latestProducts.length === 1 ? '' : 's'}.`;
      hideLoading();
    }

    // =====================
    // RENDERING
    // =====================
    function renderProducts(products) {
      productsGrid.innerHTML = '';
      if (!products || products.length === 0) { productsGrid.innerHTML = '<p class="text-gray-500 col-span-full">No products found.</p>'; return; }
      products.forEach(product => {
        const card = document.createElement('div');
        card.className = 'bg-white border rounded shadow p-4 flex flex-col';
        card.innerHTML = `
          <img src="${product.image_url}" alt="${product.title}" class="h-40 w-full object-cover rounded mb-4">
          <h3 class="text-lg font-semibold">${product.title}</h3>
          <p class="text-gray-600">Ksh ${product.price} <span class="line-through text-sm">${product.original_price ? 'Ksh ' + product.original_price : ''}</span></p>
          <p class="text-sm text-gray-500 mt-1">${product.category || ''} ${product.subcategory ? ' - ' + product.subcategory : ''}</p>
          <div class="mt-4 flex gap-2">
            <button class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded" data-action="edit" data-id="${String(product.id)}">Edit</button>
            <button class="flex-1 bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded" data-action="delete" data-id="${String(product.id)}">Delete</button>
          </div>
        `;
        productsGrid.appendChild(card);
      });
    }

    // =====================
    // EDIT & DELETE
    // =====================
    function openEditModal() {
      editStatus.textContent = '';
      editStatus.className = 'mt-2 text-sm';
      editModal.classList.remove('hidden');
      editModal.classList.add('flex');
    }
    function closeEditModal() {
      editModal.classList.add('hidden');
      editModal.classList.remove('flex');
      editingProductId = null;
      editingCurrentImageUrl = null;
      editForm.reset();
      editImagePreview.src = '';
    }

    window.editProduct = function(id) {
      const product = latestProducts.find(p => String(p.id) === String(id));
      if (!product) return;
      editingProductId = id;
      editingCurrentImageUrl = product.image_url || null;
      editTitle.value = product.title || '';
      editPrice.value = product.price ?? '';
      editOriginalPrice.value = product.original_price ?? '';
      editCategory.value = product.category || '';
      editSubcategory.value = product.subcategory || '';
      editImage.value = '';
      editImagePreview.src = editingCurrentImageUrl || '';
      openEditModal();
    }

    window.deleteProduct = async function(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;
      const idFilter = (/^\d+$/.test(String(id))) ? Number(id) : String(id);
      const { error } = await client.from('Products').delete().eq('id', idFilter);
      if (error) { alert('❌ Delete failed: ' + error.message); }
      else { alert('✅ Product deleted!'); await fetchProducts(searchInput.value.trim(), categorySelect.value, subcategorySelect.value); }
    }

    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!editingProductId) return;
      saveBtn.disabled = true;
      showLoading('Saving product...');
      editStatus.textContent = 'Saving...';
      editStatus.className = 'mt-2 text-sm text-gray-600';

      let imageUrl = editingCurrentImageUrl;
      const imageFile = editImage.files && editImage.files[0] ? editImage.files[0] : null;
      if (imageFile) {
        const fileExt = imageFile.name.split('.').pop();
        const fileName = `${Date.now()}.${fileExt}`;
        const filePath = `${fileName}`;
        const { error: uploadError } = await client.storage.from('product-images').upload(filePath, imageFile);
        if (uploadError) {
          editStatus.textContent = '❌ Image upload failed: ' + uploadError.message;
          editStatus.className = 'mt-2 text-sm text-red-600';
          hideLoading();
          saveBtn.disabled = false;
          return;
        }
        imageUrl = `${supabaseUrl}/storage/v1/object/public/product-images/${filePath}`;
      }

      const updates = {
        title: editTitle.value.trim(),
        price: editPrice.value ? Number(editPrice.value) : null,
        original_price: editOriginalPrice.value ? Number(editOriginalPrice.value) : null,
        category: editCategory.value.trim() || null,
        subcategory: editSubcategory.value.trim() || null, // description stays in subcategory field
        image_url: imageUrl || null,
      };

      const idFilter = (/^\d+$/.test(String(editingProductId))) ? Number(editingProductId) : String(editingProductId);
      const { error } = await client.from('Products').update(updates).eq('id', idFilter);
      if (error) {
        editStatus.textContent = '❌ ' + error.message;
        editStatus.className = 'mt-2 text-sm text-red-600';
      } else {
        editStatus.textContent = '✅ Saved';
        editStatus.className = 'mt-2 text-sm text-green-600';
        await fetchProducts(searchInput.value.trim(), categorySelect.value, subcategorySelect.value);
        setTimeout(closeEditModal, 500);
      }
      hideLoading();
      saveBtn.disabled = false;
    });

    closeEditModalBtn.addEventListener('click', closeEditModal);
    cancelEditBtn.addEventListener('click', closeEditModal);

    // =====================
    // EVENTS
    // =====================
    productsGrid.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      if (action === 'edit') {
        window.editProduct(id);
      } else if (action === 'delete') {
        window.deleteProduct(id);
      }
    });

    searchBtn.addEventListener('click', () => {
      const term = searchInput.value.trim();
      fetchProducts(term, categorySelect.value, subcategorySelect.value);
    });

    resetBtn.addEventListener('click', () => {
      searchInput.value = '';
      categorySelect.value = '';
      subcategorySelect.value = '';
      subcategorySelect.disabled = true;
      fetchProducts();
    });

    categorySelect.addEventListener('change', async () => {
      const category = categorySelect.value;
      await fetchSubcategories(category);
      subcategorySelect.value = '';
      const term = searchInput.value.trim();
      fetchProducts(term, category, '');
    });

    subcategorySelect.addEventListener('change', () => {
      const term = searchInput.value.trim();
      fetchProducts(term, categorySelect.value, subcategorySelect.value);
    });

    logoutBtn.addEventListener('click', async () => { await client.auth.signOut(); });

    // =====================
    // INIT
    // =====================
    (async function init() {
      const ok = await ensureAuth();
      if (!ok) return;
      await fetchCategories();
      await fetchProducts();
    })();
  </script>
</body>
</html>
