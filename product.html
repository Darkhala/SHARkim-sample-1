<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/images/icon logo.png">
  <title>Product - Sharkim Traders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: "Times New Roman", Times, serif, Arial, Helvetica, sans-serif; }
  </style>
</head>
<body class="bg-gray-50">

<!-- Minimal Header: Logo top-left, Cart top-right, Nav centered -->
<header class="bg-black text-white py-4">
  <div class="max-w-7xl mx-auto px-3">
    <div class="flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-2">
        <img src="images/sharkim_gold_logo.png" class="h-12" alt="logo">
      </a>
      <button id="cartBtn" class="flex items-center gap-2 px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M7 4h-2l-1 2H1v2h2l3.6 7.6-1.4 2.4c-.2.3-.2.8 0 1.2.2.4.6.6 1 .6h12v-2H7.4c-.1 0-.2 0-.2-.1l.9-1.5h7.9c.4 0 .7-.2.9-.5l3.6-6.5c.2-.4.1-.8 0-1.1-.2-.3-.5-.5-.9-.5H6.2L5.3 4H7zm0 16c-1.1 0-2 .9-2 2s.9 2 2 2c1.2 0 2-.9 2-2s-.8-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2c1.2 0 2-.9 2-2s-.9-2-2-2z"/></svg>
        Cart
        <span id="cartCount" class="bg-yellow-400 text-black text-xs font-bold px-2 py-0.5 rounded-full">0</span>
      </button>
    </div>
    <nav class="mt-3">
      <ul class="flex justify-center gap-6 text-sm">
        <li>
          <a href="index.html" class="flex items-center gap-2 hover:text-yellow-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3l9-8z"/></svg>
            Home
          </a>
        </li>
        <li>
          <a href="shop.html" class="flex items-center gap-2 hover:text-yellow-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M7 4h-2l-1 2H1v2h2l3.6 7.6-1.4 2.4c-.2.3-.2.8 0 1.2.2.4.6.6 1 .6h12v-2H7.4c-.1 0-.2 0-.2-.1l.9-1.5h7.9c.4 0 .7-.2.9-.5l3.6-6.5c.2-.4.1-.8 0-1.1-.2-.3-.5-.5-.9-.5H6.2L5.3 4H7z"/></svg>
            Shop
          </a>
        </li>
        <li>
          <a href="contact.html" class="flex items-center gap-2 hover:text-yellow-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M21 8V7l-3 2-2-1-4 2-4-2-4 2v10h20V8zM5 17v-6l3-1.5 4 2 4-2 3 1.5V17H5zm7-11l4 2 5-3-9-4-9 4 5 3 4-2z"/></svg>
            Contact
          </a>
        </li>
      </ul>
    </nav>
  </div>
</header>

<main class="max-w-7xl mx-auto p-4">
  <div id="content" class="bg-white rounded shadow p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <img id="pImg" src="" alt="" class="w-full h-80 object-contain rounded border">
      <div class="mt-3 flex gap-2 flex-wrap">
        <a id="btnWhats" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">WhatsApp</a>
        <a id="btnEmail" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Email</a>
        <button id="btnCart" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Add to Cart</button>
      </div>
    </div>
    <div>
      <h1 id="pTitle" class="text-2xl font-bold"></h1>
      <p id="pCat" class="text-sm text-gray-600"></p>
      <div class="my-4">
        <p id="pOriginal" class="line-through text-gray-500"></p>
        <p id="pPrice" class="text-red-600 font-bold text-2xl"></p>
        <span id="pDisc" class="hidden bg-green-600 text-white text-xs inline-block px-2 py-1 rounded mt-1"></span>
      </div>

      <!-- Description with visible intro and Read more toggle -->
      <div class="border-t pt-3">
        <h3 class="font-semibold mb-2">Description</h3>
        <div id="descPreview" class="text-gray-700 text-sm leading-relaxed"></div>
        <button id="descToggle" class="mt-2 text-blue-600 hover:underline">Read more</button>
        <div id="descBody" class="text-gray-700 text-sm leading-relaxed hidden mt-2"></div>
      </div>
    </div>
  </div>

  <section class="mt-8">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl font-semibold">Related Products</h2>
      <a id="relMore" href="shop.html" class="text-blue-600 hover:underline">See more</a>
    </div>
    <div id="relGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
  </section>
</main>

<script>
const SUPABASE_URL = 'https://evmiakneqtoxvnzeiwlz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2bWlha25lcXRveHZuemVpd2x6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMTU4NTEsImV4cCI6MjA2OTg5MTg1MX0.lgW9OGAg8etuIzWPs-t0Ek_P7y3_m5GEo-ZSzbqbsGc';
const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Elements
const pImg = document.getElementById('pImg');
const pTitle = document.getElementById('pTitle');
const pCat = document.getElementById('pCat');
const pOriginal = document.getElementById('pOriginal');
const pPrice = document.getElementById('pPrice');
const pDisc = document.getElementById('pDisc');
const btnWhats = document.getElementById('btnWhats');
const btnEmail = document.getElementById('btnEmail');
const btnCart = document.getElementById('btnCart');
const descToggle = document.getElementById('descToggle');
const descBody = document.getElementById('descBody');
const descPreview = document.getElementById('descPreview');
const relGrid = document.getElementById('relGrid');
const relMore = document.getElementById('relMore');
const cartBtn = document.getElementById('cartBtn');
const cartCountBadge = document.getElementById('cartCount');

// Cart
let cart = JSON.parse(localStorage.getItem('cart') || '[]');
function saveCart(){ localStorage.setItem('cart', JSON.stringify(cart)); }
function updateCartCount(){ if (cartCountBadge) cartCountBadge.innerText = cart.length; }
updateCartCount();

(function ensureCartDrawer(){
  if (document.getElementById('cartDrawer')) return;
  const drawer = document.createElement('div');
  drawer.id = 'cartDrawer';
  drawer.className = 'fixed top-0 right-0 w-80 max-w-full h-full bg-white shadow-lg p-4 hidden z-50';
  drawer.innerHTML = `
    <h2 class=\"text-lg font-bold mb-4\">Your Cart</h2>
    <div id=\"cartItems\" class=\"space-y-3\"></div>
    <div class=\"mt-4 border-t pt-3\">
      <p class=\"font-bold\">Total: Ksh <span id=\"cartTotal\">0</span></p>
      <div class=\"flex gap-2 mt-3\">
        <button id=\"cartWhatsApp\" class=\"bg-green-600 text-white px-3 py-2 rounded w-1/2\">WhatsApp</button>
        <button id=\"cartEmail\" class=\"bg-blue-600 text-white px-3 py-2 rounded w-1/2\">Email</button>
      </div>
    </div>
    <button id=\"cartClose\" class=\"absolute top-2 right-2 text-gray-500\">
      <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"w-5 h-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">
        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\" />
      </svg>
    </button>
  `;
  document.body.appendChild(drawer);
  document.getElementById('cartClose').onclick = closeCart;
  document.getElementById('cartWhatsApp').onclick = checkoutWhatsApp;
  document.getElementById('cartEmail').onclick = checkoutEmail;
})();

function openCart(){ renderCart(); document.getElementById('cartDrawer').classList.remove('hidden'); }
function closeCart(){ document.getElementById('cartDrawer').classList.add('hidden'); }
function renderCart(){
  const wrap = document.getElementById('cartItems');
  const totalEl = document.getElementById('cartTotal');
  wrap.innerHTML = '';
  let total = 0;
  if (cart.length === 0) { wrap.innerHTML = "<p class='text-gray-500'>Your cart is empty</p>"; totalEl.innerText = 0; return; }
  cart.forEach((item, idx) => {
    total += Number(item.price) || 0;
    const row = document.createElement('div');
    row.className = 'flex gap-2 items-center border-b pb-2';
    row.innerHTML = `
      <img src=\"${item.image_url}\" alt=\"${item.title}\" class=\"w-12 h-12 object-contain\">
      <div class=\"flex-1\">
        <p class=\"font-bold text-sm\">${item.title}</p>
        <p class=\"text-xs text-gray-600\">Ksh ${item.price}</p>
      </div>
      <button class=\"text-red-600\" aria-label=\"Remove\">
        <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"w-5 h-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">
          <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M1 7h22M10 7V5a2 2 0 114 0v2\" />
        </svg>
      </button>
    `;
    row.querySelector('button').onclick = () => { cart.splice(idx, 1); saveCart(); updateCartCount(); renderCart(); };
    wrap.appendChild(row);
  });
  totalEl.innerText = total;
}

function checkoutWhatsApp(){
  if (cart.length === 0) return alert('Your cart is empty!');
  let msg = 'ðŸ›’ *New Order from Sharkim Traders*\n\n';
  let total = 0; cart.forEach((item, i) => { msg += `${i+1}. ${item.title} - Ksh ${item.price}\n`; total += Number(item.price)||0; });
  msg += `\n----------------------\nðŸ’° *Total:* Ksh ${total}\n\n`;
  msg += 'ðŸ“ Please confirm delivery details.';
  window.open(`https://wa.me/+254704843554?text=${encodeURIComponent(msg)}`, '_blank');
}
function checkoutEmail(){
  if (cart.length === 0) return alert('Your cart is empty!');
  let subject = 'ðŸ›’ New Cart Order - Sharkim Traders';
  let body = 'Hello Sharkim Traders,\n\nI\'d like to order the following products:\n\n';
  let total = 0; cart.forEach((item, i) => { body += `${i+1}. ${item.title} - Ksh ${item.price}\n`; total += Number(item.price)||0; });
  body += `\n----------------------\nTotal: Ksh ${total}\n\n`;
  body += 'Customer details:\nName: __________\nPhone: __________\nLocation: __________';
  window.location.href = `mailto:sharkimtraders97@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}
if (cartBtn) cartBtn.onclick = openCart;

function qs(){ return new URLSearchParams(window.location.search); }

async function fetchProduct(id){
  const { data, error } = await client.from('Products').select('*').eq('id', id).single();
  if (error || !data){ document.getElementById('content').innerHTML = '<p class="p-6">Product not found.</p>'; return; }
  const p = {
    ...data,
    main_category: data.main_category || data.category || 'Uncategorized',
    description: data.description || data.subcategory || ''
  };

  pImg.src = p.image_url;
  pTitle.textContent = p.title;
  pCat.textContent = `${p.main_category}${p.subcategory ? ' > ' + p.subcategory : ''}${p.brand ? ' â€¢ ' + p.brand : ''}`;
  pOriginal.textContent = p.original_price ? `Ksh ${p.original_price}` : '';
  pPrice.textContent = `Ksh ${p.price}`;
  const disc = (p.original_price && p.original_price>0) ? Math.round(((p.original_price - p.price)/p.original_price)*100) : 0;
  if (disc){ pDisc.textContent = `${disc}% OFF`; pDisc.classList.remove('hidden'); }

  const fullDesc = p.description || 'No description available';
  const previewText = fullDesc.length > 220 ? (fullDesc.slice(0, 220) + '...') : fullDesc;
  descPreview.textContent = previewText;
  descBody.textContent = fullDesc;
  let expanded = false;
  descToggle.onclick = () => {
    expanded = !expanded;
    if (expanded){
      descBody.classList.remove('hidden');
      descToggle.textContent = 'Show less';
    } else {
      descBody.classList.add('hidden');
      descToggle.textContent = 'Read more';
    }
  };

  btnWhats.href = `https://wa.me/254704843554?text=${encodeURIComponent('I want ' + p.title)}`;
  btnEmail.href = `mailto:sharkimtraders97@gmail.com?subject=${encodeURIComponent('Product Inquiry: ' + p.title)}&body=${encodeURIComponent('I am interested in ' + p.title)}`;
  btnCart.onclick = () => { cart.push({ id: p.id, title: p.title, price: p.price, image_url: p.image_url }); saveCart(); updateCartCount(); alert('Added to cart âœ…'); };

  // Related: same main category
  relMore.href = `shop.html?main=${encodeURIComponent(p.main_category)}`;
  fetchRelated(p);
}

async function fetchRelated(p){
  const { data, error } = await client
    .from('Products')
    .select('*')
    .eq('main_category', p.main_category)
    .neq('id', p.id)
    .limit(12);
  if (error) { console.error(error); return; }
  relGrid.innerHTML = '';
  (data||[]).forEach(item => {
    const el = document.createElement('a');
    el.href = `product.html?id=${encodeURIComponent(item.id)}`;
    el.className = 'bg-white border rounded p-3 shadow hover:shadow-md transition block';
    el.innerHTML = `
      <img src=\"${item.image_url}\" class=\"h-28 w-full object-contain mb-2\" alt=\"${item.title}\">
      <div class=\"text-sm font-semibold line-clamp-2\">${item.title}</div>
      <div class=\"text-red-600 font-bold\">Ksh ${item.price}</div>
    `;
    relGrid.appendChild(el);
  });
}

const id = qs().get('id');
if (id) fetchProduct(id);
</script>
</body>
</html>