<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Product - Sharkim Traders</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100 p-6">

  <div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-2xl font-bold mb-6">Upload Product</h2>

    <form id="uploadForm" class="space-y-4">
      <!-- Product Title -->
      <input type="text" id="title" placeholder="Product Title"
             class="w-full px-4 py-2 border rounded" required>

      <!-- Prices -->
      <div class="flex gap-4">
        <input type="number" id="price" placeholder="New Price (Ksh)"
               class="w-full px-4 py-2 border rounded" required>
        <input type="number" id="originalPrice" placeholder="Original Price (Ksh)"
               class="w-full px-4 py-2 border rounded" required>
      </div>

      <!-- Category -->
      <select id="category" class="w-full px-4 py-2 border rounded" required>
        <option value="">-- Select Category --</option>
        <option>Electronics & Technology</option>
        <option>Computer Accessories</option>
        <option>Audio & Music Equipment</option>
        <option>Cameras & Video Gear</option>
        <option>Security & Surveillance</option>
        <option>Printers & Scanners</option>
        <option>Software & Games</option>
        <option>Laptops & Desktops</option>
        <option>TV & DVD Equipment</option>
        <option>Video Game Consoles & Game</option>
        <option>Mobile Phones & Tablets</option>
        <option>Mobile Phones</option>
        <option>Phone Accessories</option>
        <option>Tablets</option>
        <option>Smart Watches & Trackers</option>
        <option>Fashion & Beauty</option>
        <option>Clothing & Accessories</option>
        <option>Shoes</option>
        <option>Bags</option>
        <option>Jewelry</option>
        <option>Watches</option>
        <option>Wedding Wear & Accessories</option>
        <option>Bath & Body, Makeup, Fragrance</option>
        <option>Hair & Skin Care</option>
        <option>Sexual Wellness</option>
        <option>Babies & Kids: Clothing, Toys, Prams, Children’s Gear</option>
        <option>Food, Agriculture & Farming</option>
        <option>Commercial Equipment & Tools</option>
        <option>Repair & Construction</option>
      </select>

      <!-- Subcategory -->
      <input type="text" id="subcategory" placeholder="Subcategory (optional)"
             class="w-full px-4 py-2 border rounded">

      <!-- Image Upload -->
      <input type="file" id="image" accept="image/*"
             class="w-full px-4 py-2 border rounded" required>

      <!-- Submit Button -->
      <button type="submit"
              class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">
        Upload
      </button>
    </form>

    <p id="status" class="mt-4 text-sm text-gray-700"></p>
  </div>

  <script>
    window.onload = () => {
    const supabaseUrl = "https://evmiakneqtoxvnzeiwlz.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2bWlha25lcXRveHZuemVpd2x6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMTU4NTEsImV4cCI6MjA2OTg5MTg1MX0.lgW9OGAg8etuIzWPs-t0Ek_P7y3_m5GEo-ZSzbqbsGc"; 
    const client = window.supabase.createClient(supabaseUrl, supabaseKey);

      const statusText = document.getElementById('status');

      // ✅ Redirect if not logged in
      client.auth.getUser().then(({ data: { user } }) => {
        if (!user) {
          window.location.href = "login.html";
        }
      });

      // ✅ Handle Form Submission
      document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        statusText.textContent = 'Uploading...';

        const title = document.getElementById('title').value.trim();
        const price = parseFloat(document.getElementById('price').value);
        const originalPrice = parseFloat(document.getElementById('originalPrice').value);
        const category = document.getElementById('category').value;
        const subcategory = document.getElementById('subcategory').value.trim();
        const imageFile = document.getElementById('image').files[0];

        if (!imageFile) {
          statusText.textContent = '❌ No image selected.';
          return;
        }

        const fileExt = imageFile.name.split('.').pop();
        const fileName = `${Date.now()}.${fileExt}`;
        const filePath = `${fileName}`;

        try {
          // ✅ Upload image
          const { data: imageUpload, error: uploadError } = await client
            .storage
            .from('product-images')
            .upload(filePath, imageFile);

          if (uploadError) {
            console.error('❌ Image Upload Error:', uploadError.message);
            statusText.textContent = '❌ Upload failed: ' + uploadError.message;
            return;
          }

          const imageUrl = `${supabaseUrl}/storage/v1/object/public/product-images/${filePath}`;

          // ✅ Insert product into DB
          const { error: insertError } = await client
            .from('Products')
            .insert([{
              title,
              price,
              original_price: originalPrice,
              image_url: imageUrl,
              category,
              subcategory
            }]);

          if (insertError) {
            console.error('❌ Database Insert Error:', insertError.message);
            statusText.textContent = '❌ Database error: ' + insertError.message;
          } else {
            statusText.textContent = '✅ Product uploaded successfully!';
            document.getElementById('uploadForm').reset();
          }

        } catch (err) {
          console.error('❌ Unexpected Error:', err);
          statusText.textContent = '❌ Unexpected error: ' + err.message;
        }

        statusText.scrollIntoView({ behavior: 'smooth' });
      });
    };
  </script>
</body>
</html>
