<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sharkim Traders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100">

  <!-- HEADER -->
  <header class="bg-[#af8532] text-black px-6 py-4 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <img src="images/sharkim black logo.png" alt="Sharkim Logo" class="h-20">
      <h1 class="text-2xl font-bold"></h1>
    </div>
    <div class="flex gap-4 items-center">
      <button id="authBtn" class="bg-white text-red-600 px-4 py-2 rounded">Login / Register</button>
      <div id="userSection" class="hidden flex items-center gap-3">
        <span id="username"></span>
        <button id="logoutBtn" class="bg-black text-white px-3 py-1 rounded">Logout</button>
        <button id="cartBtn" class="relative">
          🛒 <span id="cartCount" class="absolute -top-2 -right-2 bg-gold text-black rounded-full px-2 text-xs">0</span>
        </button>
      </div>
    </div>
  </header>

  <!-- BANNER -->
  <section class="bg-black text-white text-center py-6">
    <h2 class="text-3xl font-semibold">Best Appliances Discount</h2>
    <p class="text-gray-300">Shop now & save up to 40%</p>
    <button class="mt-4 px-6 py-2 bg-red-600 rounded text-white">Shop Now</button>
  </section>

  <!-- CATEGORIES BAR -->
  <nav class="bg-white shadow p-3 overflow-x-auto whitespace-nowrap">
    <div id="categoryTabs" class="flex gap-4 text-sm font-medium"></div>
  </nav>

  <!-- MAIN PRODUCT SECTIONS -->
  <main class="p-6 space-y-12" id="mainContent"></main>

  <!-- PRODUCT OVERLAY -->
  <div id="productOverlay" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-lg w-full relative">
      <button onclick="closeOverlay()" class="absolute top-2 right-2 text-gray-500">✖</button>
      <img id="overlayImage" src="" alt="" class="h-48 mx-auto object-contain mb-4">
      <h2 id="overlayTitle" class="text-xl font-bold"></h2>
      <p id="overlayCategory" class="text-sm text-gray-500"></p>
      <p class="line-through text-gray-500">Ksh <span id="overlayOriginal"></span></p>
      <p class="text-red-600 font-bold">Ksh <span id="overlayPrice"></span></p>
      <p class="bg-green-600 text-white text-xs inline-block px-2 py-1 rounded mt-1"><span id="overlayDiscount"></span>% OFF</p>
      <div class="flex gap-2 mt-4">
        <a id="overlayWhatsapp" target="_blank" class="px-3 py-1 bg-green-500 text-white rounded">WhatsApp</a>
        <button onclick="openEmailForm(document.getElementById('overlayTitle').innerText)" class="px-3 py-1 bg-blue-500 text-white rounded">Email</button>
        <button id="addToCartBtn" class="px-3 py-1 bg-red-600 text-white rounded">Add to Cart</button>
      </div>
    </div>
  </div>

  <!-- AUTH OVERLAY -->
  <div id="authOverlay" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96">
      <h2 class="text-lg font-bold mb-4">Login / Register</h2>
      <form id="authForm" class="space-y-3">
        <input type="email" id="authEmail" placeholder="Email" class="w-full border px-3 py-2 rounded" required>
        <input type="password" id="authPassword" placeholder="Password" class="w-full border px-3 py-2 rounded" required>
        <button type="submit" class="w-full bg-red-600 text-white py-2 rounded">Submit</button>
      </form>
      <button onclick="closeAuth()" class="mt-3 text-sm text-gray-500">Cancel</button>
    </div>
  </div>

  <!-- Email Overlay (existing) -->
  <div id="emailOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="bg-white p-6 rounded-lg w-96 shadow-lg">
      <h2 class="text-lg font-bold mb-4">Send Email Inquiry</h2>
      <form id="emailForm" class="space-y-3">
        <input type="hidden" id="productInfo">
        <div>
          <label class="block text-sm">Name:</label>
          <input type="text" id="name" class="w-full border px-3 py-2 rounded" required>
        </div>
        <div>
          <label class="block text-sm">Phone Number:</label>
          <input type="text" id="phone" class="w-full border px-3 py-2 rounded" required>
        </div>
        <div>
          <label class="block text-sm">Location:</label>
          <input type="text" id="location" class="w-full border px-3 py-2 rounded" required>
        </div>
        <div>
          <label class="block text-sm">Message:</label>
          <textarea id="message" class="w-full border px-3 py-2 rounded" rows="4" readonly></textarea>
        </div>
        <div class="flex justify-between mt-4">
          <button type="button" id="cancelEmail" class="px-4 py-2 bg-gray-400 text-white rounded">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded">Send</button>
        </div>
      </form>
    </div>
  </div>

<script>
// =====================
// CONFIG & SUPABASE
// =====================
const SUPABASE_URL = 'https://evmiakneqtoxvnzeiwlz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2bWlha25lcXRveHZuemVpd2x6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMTU4NTEsImV4cCI6MjA2OTg5MTg1MX0.lgW9OGAg8etuIzWPs-t0Ek_P7y3_m5GEo-ZSzbqbsGc';
const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// =====================
// ELEMENTS (existing in your HTML)
// =====================
const mainContent = document.getElementById("mainContent");
const tabs = document.getElementById("categoryTabs");
const searchInput = document.getElementById("searchInput");

// Overlays that already exist in your HTML
const productOverlay = document.getElementById("productOverlay");
const overlayImage = document.getElementById("overlayImage");
const overlayTitle = document.getElementById("overlayTitle");
const overlayCategory = document.getElementById("overlayCategory");
const overlayOriginal = document.getElementById("overlayOriginal");
const overlayPrice = document.getElementById("overlayPrice");
const overlayDiscount = document.getElementById("overlayDiscount");
const overlayWhatsapp = document.getElementById("overlayWhatsapp");
const addToCartBtn = document.getElementById("addToCartBtn");

const emailOverlay = document.getElementById("emailOverlay");
const emailForm = document.getElementById("emailForm");

// Auth bits
const authBtn = document.getElementById("authBtn");
const authOverlay = document.getElementById("authOverlay");
const authForm = document.getElementById("authForm");
const logoutBtn = document.getElementById("logoutBtn");
const userSection = document.getElementById("userSection");
const usernameEl = document.getElementById("username");

// Optional cart button from your header (inside userSection)
const cartBtn = document.getElementById("cartBtn");
const cartCountBadge = document.getElementById("cartCount");

// =====================
// CART (localStorage)
// =====================
let cart = JSON.parse(localStorage.getItem("cart") || "[]");
function saveCart() { localStorage.setItem("cart", JSON.stringify(cart)); }
function updateCartCount() {
  if (cartCountBadge) cartCountBadge.innerText = cart.length;
}
updateCartCount();

// Create Cart Drawer dynamically if not present
(function ensureCartDrawer(){
  if (document.getElementById("cartDrawer")) return;
  const drawer = document.createElement("div");
  drawer.id = "cartDrawer";
  drawer.className = "fixed top-0 right-0 w-80 max-w-full h-full bg-white shadow-lg p-4 hidden z-50";
  drawer.innerHTML = `
    <h2 class="text-lg font-bold mb-4">Your Cart</h2>
    <div id="cartItems" class="space-y-3"></div>
    <div class="mt-4 border-t pt-3">
      <p class="font-bold">Total: Ksh <span id="cartTotal">0</span></p>
      <div class="flex gap-2 mt-3">
        <button id="cartWhatsApp" class="bg-green-600 text-white px-3 py-2 rounded w-1/2">WhatsApp</button>
        <button id="cartEmail" class="bg-blue-600 text-white px-3 py-2 rounded w-1/2">Email</button>
      </div>
    </div>
    <button id="cartClose" class="absolute top-2 right-2 text-red-600 font-bold">✖</button>
  `;
  document.body.appendChild(drawer);

  // attach handlers
  document.getElementById("cartClose").onclick = closeCart;
  document.getElementById("cartWhatsApp").onclick = checkoutWhatsApp;
  document.getElementById("cartEmail").onclick = checkoutEmail;
})();
function openCart() {
  renderCart();
  document.getElementById("cartDrawer").classList.remove("hidden");
}
function closeCart() {
  document.getElementById("cartDrawer").classList.add("hidden");
}
function renderCart() {
  const wrap = document.getElementById("cartItems");
  const totalEl = document.getElementById("cartTotal");
  wrap.innerHTML = "";
  let total = 0;
  if (cart.length === 0) {
    wrap.innerHTML = "<p class='text-gray-500'>Your cart is empty 🛒</p>";
    totalEl.innerText = 0;
    return;
  }
  cart.forEach((item, idx) => {
    total += Number(item.price) || 0;
    const row = document.createElement("div");
    row.className = "flex gap-2 items-center border-b pb-2";
    row.innerHTML = `
      <img src="${item.image_url}" alt="${item.title}" class="w-12 h-12 object-contain">
      <div class="flex-1">
        <p class="font-bold text-sm">${item.title}</p>
        <p class="text-xs text-gray-600">Ksh ${item.price}</p>
      </div>
      <button class="text-red-600" aria-label="Remove">🗑</button>
    `;
    row.querySelector("button").onclick = () => {
      cart.splice(idx, 1);
      saveCart();
      updateCartCount();
      renderCart();
    };
    wrap.appendChild(row);
  });
  totalEl.innerText = total;
}
function checkoutWhatsApp() {
  if (cart.length === 0) return alert("Your cart is empty!");
  let msg = "Hello, I'd like to order:\n\n";
  let total = 0;
  cart.forEach(i => { msg += `- ${i.title} @ Ksh ${i.price}\n`; total += Number(i.price)||0; });
  msg += `\nTotal: Ksh ${total}`;
  window.open(`https://wa.me/254700000000?text=${encodeURIComponent(msg)}`, "_blank");
}
function checkoutEmail() {
  if (cart.length === 0) return alert("Your cart is empty!");
  let subject = "Cart Order Request";
  let body = "Hello,\nI'd like to order the following:\n\n";
  let total = 0;
  cart.forEach(i => { body += `- ${i.title} @ Ksh ${i.price}\n`; total += Number(i.price)||0; });
  body += `\nTotal: Ksh ${total}`;
  window.location.href = `mailto:sharkimtraders97@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}
// Attach header cart button if present
if (cartBtn) cartBtn.onclick = openCart;

// =====================
// AUTH (login + signup in same overlay)
// =====================
// Inject a toggle for sign up / login if not present
(function ensureAuthToggle(){
  if (!authOverlay) return;
  if (document.getElementById("authToggleLink")) return;
  const toggle = document.createElement("button");
  toggle.id = "authToggleLink";
  toggle.type = "button";
  toggle.className = "mt-3 text-sm text-blue-600 underline";
  toggle.textContent = "Don't have an account? Create one";
  authOverlay.querySelector(".bg-white").appendChild(toggle);
})();
let authMode = "login"; // or "signup"

function openAuth() { if (authOverlay) authOverlay.classList.remove("hidden"); }
function closeAuth() { if (authOverlay) authOverlay.classList.add("hidden"); }
if (authBtn) authBtn.onclick = openAuth;
const authToggleLink = document.getElementById("authToggleLink");
if (authToggleLink) {
  authToggleLink.onclick = () => {
    authMode = authMode === "login" ? "signup" : "login";
    if (authMode === "signup") {
      authToggleLink.textContent = "Already have an account? Log in";
    } else {
      authToggleLink.textContent = "Don't have an account? Create one";
    }
  };
}
if (authForm) {
  authForm.onsubmit = async (e) => {
    e.preventDefault();
    const email = document.getElementById("authEmail").value.trim();
    const password = document.getElementById("authPassword").value;

    try {
      if (authMode === "signup") {
        // Simple signup: email/password; you can later add name capture and pass in user_metadata
        const { data, error } = await client.auth.signUp({ email, password });
        if (error) throw error;
        alert("Signup successful. Please check your email to confirm, then log in.");
        authMode = "login";
        if (authToggleLink) authToggleLink.textContent = "Don't have an account? Create one";
      } else {
        const { data, error } = await client.auth.signInWithPassword({ email, password });
        if (error) throw error;
        location.reload();
      }
    } catch (err) {
      alert(err.message || "Authentication error");
    }
  };
}
if (logoutBtn) {
  logoutBtn.onclick = async () => {
    await client.auth.signOut();
    location.reload();
  };
}
async function checkSession() {
  const { data: { user } } = await client.auth.getUser();
  if (user) {
    if (authBtn) authBtn.classList.add("hidden");
    if (userSection) userSection.classList.remove("hidden");

    const displayName = (user.user_metadata && user.user_metadata.name)
      ? user.user_metadata.name
      : (user.email ? user.email.split("@")[0] : "User");
    if (usernameEl) usernameEl.textContent = displayName;
  }
}
checkSession();

// =====================
// PRODUCTS (keep your original UI & categories)
// =====================
const categories = [
  "Electronics & Technology", "Computer Accessories", "Audio & Music Equipment",
  "Cameras & Video Gear", "Security & Surveillance", "Printers & Scanners",
  "Software & Games", "Laptops & Desktops", "TV & DVD Equipment",
  "Video Game Consoles & Game", "Mobile Phones & Tablets", "Mobile Phones",
  "Phone Accessories", "Tablets", "Smart Watches & Trackers",
  "Fashion & Beauty", "Clothing & Accessories", "Shoes",
  "Bags", "Jewelry", "Watches", "Wedding Wear & Accessories",
  "Bath & Body, Makeup, Fragrance", "Hair & Skin Care", "Sexual Wellness",
  "Babies & Kids: Clothing, Toys, Prams, Children’s Gear",
  "Food, Agriculture & Farming", "Commercial Equipment & Tools",
  "Repair & Construction"
];

const categoryContainers = {}; // id -> element

// build category tabs + sections exactly like your original
categories.forEach(cat => {
  const btn = document.createElement("button");
  btn.className = "px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600";
  btn.innerText = cat;
  btn.onclick = () => document.getElementById(cat)?.scrollIntoView({ behavior: 'smooth' });
  tabs.appendChild(btn);

  const section = document.createElement("section");
  section.innerHTML = `
    <h2 class="text-xl font-bold mb-4">${cat}</h2>
    <div id="${cat}" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
  `;
  mainContent.appendChild(section);
  categoryContainers[cat] = section.querySelector(`#${CSS.escape(cat)}`);
});

let allProducts = []; // cache for search/filter

async function fetchProducts() {
  const { data, error } = await client.from('Products').select('*');
  if (error) { console.error("❌ Error fetching products:", error); return; }
  allProducts = data || [];
  renderProducts(allProducts);
}
function renderProducts(products) {
  // clear
  Object.values(categoryContainers).forEach(c => c.innerHTML = "");
  products.forEach(product => {
    const container = categoryContainers[product.category];
    if (!container) return;

    const discount = Math.round(((product.original_price - product.price) / product.original_price) * 100);
    const card = document.createElement('div');
    card.className = "bg-white p-3 rounded shadow text-center cursor-pointer";
    card.innerHTML = `
      <img src="${product.image_url}" alt="${product.title}" class="h-32 mx-auto object-contain mb-2">
      <h3 class="text-sm font-bold">${product.title}</h3>
      <p class="text-xs line-through text-gray-500">Ksh ${product.original_price}</p>
      <p class="text-red-600 font-bold">Ksh ${product.price}</p>
      <span class="bg-green-600 text-white text-xs px-2 py-1 rounded inline-block mt-1">${discount}% OFF</span>
      <div class="mt-3 flex justify-center gap-2">
        <a href="https://wa.me/254700000000?text=I want ${encodeURIComponent(product.title)}" target="_blank" class="px-3 py-1 bg-green-500 text-white rounded">WhatsApp</a>
        <button class="px-3 py-1 bg-blue-500 text-white rounded">Email</button>
      </div>
    `;
    // product overlay on click (outside buttons)
    card.addEventListener("click", (e)=>{
      // avoid triggering when clicking whatsapp/email buttons
      if (e.target.tagName === "A" || e.target.tagName === "BUTTON") return;
      openOverlay(product);
    });
    // email button
    card.querySelector("button").onclick = () => openEmailForm(product.title);

    container.appendChild(card);
  });
}
fetchProducts();

// search filter (title/category/subcategory)
if (searchInput) {
  searchInput.addEventListener("input", () => {
    const q = searchInput.value.trim().toLowerCase();
    if (!q) return renderProducts(allProducts);
    const filtered = allProducts.filter(p =>
      (p.title||"").toLowerCase().includes(q) ||
      (p.category||"").toLowerCase().includes(q) ||
      (p.subcategory||"").toLowerCase().includes(q)
    );
    renderProducts(filtered);
  });
}

// =====================
// PRODUCT OVERLAY + EMAIL OVERLAY
// =====================
function openOverlay(product) {
  overlayImage.src = product.image_url;
  overlayTitle.innerText = product.title;
  overlayCategory.innerText = `${product.category} ${product.subcategory ? "→ " + product.subcategory : ""}`;
  overlayOriginal.innerText = product.original_price;
  overlayPrice.innerText = product.price;
  overlayDiscount.innerText = Math.round(((product.original_price - product.price) / product.original_price) * 100);
  overlayWhatsapp.href = `https://wa.me/254700000000?text=${encodeURIComponent("I want " + product.title)}`;

  // Add to cart requires login
  addToCartBtn.onclick = async () => {
    const { data: { user } } = await client.auth.getUser();
    if (!user) {
      openAuth();
      return;
    }
    cart.push({
      id: product.id,
      title: product.title,
      price: product.price,
      image_url: product.image_url
    });
    saveCart();
    updateCartCount();
    alert("Added to cart ✅");
  };

  productOverlay.classList.remove("hidden");
}
function closeOverlay(){ productOverlay.classList.add("hidden"); }
window.closeOverlay = closeOverlay; // keep your inline onclick working

// Your existing email logic preserved
function openEmailForm(productTitle) {
  emailOverlay.classList.remove("hidden");
  const message = `I want ${productTitle}`;
  document.getElementById("productInfo").value = productTitle;
  document.getElementById("message").value = message;
}
document.getElementById("cancelEmail").onclick = function() {
  emailOverlay.classList.add("hidden");
};
emailForm.onsubmit = function(e) {
  e.preventDefault();
  const name = document.getElementById("name").value;
  const phone = document.getElementById("phone").value;
  const location = document.getElementById("location").value;
  const product = document.getElementById("productInfo").value;
  const emailMessage = document.getElementById("message").value;
  const body = `Product: ${product}%0AName: ${name}%0APhone: ${phone}%0ALocation: ${location}%0AMessage: ${emailMessage}`;
  window.location.href = `mailto:sharkimtraders97@gmail.com?subject=Product Inquiry&body=${body}`;
  emailOverlay.classList.add("hidden");
};
</script>

</body>
</html>
